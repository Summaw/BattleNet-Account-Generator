class BG{static exec(e,a){return new Promise(t=>{try{chrome.runtime.sendMessage({method:e,data:a},t)}catch(e){t()}})}}class Net{static async fetch(e,t){return BG.exec("fetch",{url:e,options:t})}}class Image{static encode(t){return new Promise(a=>{if(null===t)return a(null);const e=new XMLHttpRequest;e.onload=()=>{const t=new FileReader;t.onloadend=()=>{let e=t.result;if(e.startsWith("data:text/html;base64,"))return a(null);e=e.replace("data:image/jpeg;base64,",""),a(e)},t.readAsDataURL(e.response)},e.onerror=()=>{a(null)},e.onreadystatechange=()=>{4==this.readyState&&200!=this.status&&a(null)},e.open("GET",t),e.responseType="blob",e.send()})}}class NopeCHA{static INFERENCE_URL="https://api.nopecha.com";static MAX_WAIT_POST=60;static MAX_WAIT_GET=60;static ERRORS={UNKNOWN:9,INVALID_REQUEST:10,RATE_LIIMTED:11,BANNED_USER:12,NO_JOB:13,INCOMPLETE_JOB:14,INVALID_KEY:15,NO_CREDIT:16,UPDATE_REQUIRED:17};static async post({captcha_type:e,task:t,image_urls:a,image_data:r,grid:o,key:n}){for(var i=Date.now(),s=await BG.exec("info_tab");!(Date.now()-i>1e3*NopeCHA.MAX_WAIT_POST);){var c={type:e,task:t,v:chrome.runtime.getManifest().version,key:n,url:s?s.url:window.location.href},c=(a&&(c.image_urls=a),r&&(c.image_data=r),o&&(c.grid=o),await Net.fetch(NopeCHA.INFERENCE_URL,{method:"POST",body:JSON.stringify(c),headers:{"Content-Type":"application/json"}}));try{var l=JSON.parse(c);if("error"in l){if(l.error===NopeCHA.ERRORS.RATE_LIMITED){await Time.sleep(2e3);continue}if(l.error===NopeCHA.ERRORS.INVALID_KEY)break;if(l.error===NopeCHA.ERRORS.NO_CREDIT)break;break}var E=l.data;return await NopeCHA.get({job_id:E,key:n})}catch(e){break}}return{job_id:null,data:null}}static async get({key:e,job_id:t}){for(var a=Date.now();!(Date.now()-a>1e3*NopeCHA.MAX_WAIT_GET);){await Time.sleep(500);var r=await Net.fetch(NopeCHA.INFERENCE_URL+`?id=${t}&key=`+e);try{var o=JSON.parse(r);if(!("error"in o))return{job_id:t,data:o.data};if(o.error!==NopeCHA.ERRORS.INCOMPLETE_JOB)return{job_id:t,data:null}}catch(e){break}}return{job_id:t,data:null}}}
